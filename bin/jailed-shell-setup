#!/bin/sh
#
# Copyright (C) 2017 Ruilin Peng (Nick) <pymumu@gmail.com>
#

JAIL_ROOT_DIR=/var/run/jail-shell
CONF_PATH=/etc/jailed-shell/jail-config
JAIL_SHELL_HOME=/usr/local/jailed-shell
COMMAND_PATH=$JAIL_SHELL_HOME/command
JAIL_COMMAND_PATH=
JAILED_CMD=/usr/bin/jailed-cmd
ELF_FILE_LIST="`mktemp`"

showhelp()
{
	echo "Usage: jailed-shell-setup [OPTION]"
	echo "Options:"
	echo "  --list        list jail names."
	echo "  --setup       setup jailed-shell."
	echo "-h, --help      show this help message."
}

link_cp()
{
	local src=$1
	local target=$2
	if [ -d "$target" ]; then
		target="$target/`basename $src`"
	fi

	ln -f $src $target 2>/dev/null
	if [ $? -eq 0 ]; then
		return 0
	fi

	cp -a $1 $2
}

cp_lib()
{
	local LIBS_FILE="${ELF_FILE_LIST}.LIBS"
	local LIBS_ALL_FILE="${ELF_FILE_LIST}.LIBS_UNIQ"
	> $LIBS_FILE
	while read FILE
	do
		ldd $FILE >> $LIBS_FILE 2>/dev/null
	done < $ELF_FILE_LIST

	sort $LIBS_FILE | grep -v "not a dynamic" | grep -v "linux-vdso.so" | awk '{if(NF == 2){print $1}else{print $3}}' | uniq > $LIBS_ALL_FILE

	while read FILE
	do
		DIR="`dirname $FILE`"
		LIB_FILE="$FILE"
		if [ -h "$FILE" ]; then
			if [ ! -d "$1/$DIR" ]; then
				mkdir -m 0755 -p $1/$DIR
			fi
			link_cp $FILE $1/$DIR/
			LIB_FILE="`readlink -e $FILE`"
		fi
		DIR="`dirname $LIB_FILE`"
		if [ ! -d "$1/$DIR" ]; then
			mkdir -m 0755 -p $1/$DIR
		fi
		link_cp $LIB_FILE $1/$DIR/
	done < $LIBS_ALL_FILE

	rm -f $LIBS_ALL_FILE
	rm -f $LIBS_FILE
}

add_elf_file()
{
	echo $1 >> $ELF_FILE_LIST
}

dir()
{
	local userinfo="$4"
	if [ $# -ne 4 ]; then
		return 1
	fi
	user=${userinfo##*:}
	group=${userinfo#*:}
	install -o $user -g $group -m $3 -d $1/$2  
}

file()
{
	local userinfo="$5"
	if [ $# -ne 5 ]; then
		return 1
	fi
	user=${userinfo##*:}
	group=${userinfo#*:}
	cp -a $2 $1/$3
	if [ $? -ne 0 ]; then
		return 1
	fi

	chown $user:$group $1/$3
	chmod $4 $1/$3
	add_elf_file "$1/$3"
}

clink() 
{
	if [ $# -ne 3 ]; then
		return 1
	fi

	if [ -h "$2" ]; then
		LINKED_FILE="`readlink -e $2`"
		cp -a $2 $1/$2
		if [ $? -ne 0 ]; then
			return 1
		fi
		clink $1 $LINKED_FILE $LINKED_FILE
		return $?
	fi

	link_cp $2 $1/$3
	if [ $? -ne 0 ]; then
		return 1
	fi

	add_elf_file "$1/$3"
}

hlink()
{
	if [ $# -ne 3 ]; then
		return 1
	fi

	ln -f $2 $1/$3
	if [ $? -ne 0 ]; then
		return 1
	fi

	add_elf_file "$1/$3"
}

slink()
{
	if [ $# -ne 3 ]; then
		return 1
	fi

	ln -f -s $2 $1/$3
}

cmd()
{
	local userinfo="$5"
	if [ $# -lt 5 ]; then
		return 1
	fi
	user=${userinfo##*:}
	group=${userinfo#*:}

	ln -f -s $JAILED_CMD $1$2
	if [ $? -ne 0 ]; then
		return 1
	fi

	LINK_NAME="`basename $2`"
	ln -f -s $3 $JAIL_COMMAND_PATH/$LINK_NAME
	if [ $? -ne 0 ]; then
		return 1
	fi
}

setup_jail()
{
	local jail_name=$1
	local jail_cfg=$2
	local cp_cmd=0
	
	if [ -z "$jail_name" ]; then
		return 1
	fi

	if [ ! -f "$jail_cfg" ]; then
	   return 1
   	fi	

	JAIL_COMMAND_PATH=$COMMAND_PATH/$jail_name
	mkdir $JAIL_COMMAND_PATH 2>/dev/null

	LINE_NO=0
	while read CMD ARGS;
	do
		LINE_NO=$((LINE_NO+1))
		case "$CMD" in
		""|\#*)
			continue
			;;
		dir | file | hlink | slink | clink)
			;;
		cmd)
			cp_cmd=1
			;;
		*)
			echo "unknown command at line $LINE_NO: $CMD $ARGS"
			return 1
			;;
		esac

		$CMD $JAIL_ROOT_DIR/$jail_name $ARGS
		if [ $? -ne 0 ]; then
			echo "command failed at line $LINE_NO: $CMD $ARGS"
			return 1
		fi
	done < $jail_cfg

	if [ $cp_cmd -eq 1 ]; then
		clink $JAIL_ROOT_DIR/$jail_name $JAIL_SHELL_HOME/jailed-cmd/jailed-cmd $JAILED_CMD 
		if [ $? -ne 0 ]; then
			echo "copy jailed-cmd failed."
			return 1
		fi
	fi

	cp_lib $JAIL_ROOT_DIR/$jail_name
	if [ $? -ne 0 ]; then
		echo "copy lib failed."
		return 1
	fi
}

setup_jails()
{
	for JAIL_CFG in `ls $CONF_PATH/*.cfg 2>/dev/null`
	do
		JAIL_NAME="`basename $JAIL_CFG .cfg`"
		setup_jail "$JAIL_NAME" "$JAIL_CFG"
	done
}

list_jail() 
{
	for JAIL_CFG in `ls $CONF_PATH/*.cfg 2>/dev/null`
	do
		JAIL_NAME="`basename $JAIL_CFG .cfg`"
		echo "$JAIL_NAME"
	done	
}

main()
{
	OPTS=`getopt -o h --long help,setup,list \
		-n  "" -- "$@"`

	if [ $# -eq 0 ]; then
		showhelp
		return 0
	fi

	if [ $? != 0 ] ; then echo "Terminating..." >&2 ; exit 1 ; fi

	# Note the quotes around `$OPTS': they are essential!
	eval set -- "$OPTS"

	while true; do
		case "$1" in
		-h | --help )
			showhelp
			return $!
			shift ;;
		--setup )
			setup_jails
			return $?
			shift ;;
		--list )
			list_jail
			return 0
			;;
		-- ) shift; break ;;
		* ) break ;;
  		esac
	done
}

main $@
ret=$?
rm -fr $ELF_FILE_LIST
exit $ret
